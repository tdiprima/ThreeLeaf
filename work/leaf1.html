<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Three.js with Leaflet Overlay</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
      z-index: 0;
    }

    #webgl-container {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
      z-index: 1;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div id="webgl-container"></div>

<!-- Add Three.js and Leaflet.js libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
  // Leaflet map setup
  const map = L.map('map').setView([51.505, -0.09], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  // Create a custom layer for Three.js content overlay
  const customLayer = L.Layer.extend({
    onAdd: function (map) {
      this._map = map;

      // Create a container div for Three.js content
      this._container = L.DomUtil.create('div', 'leaflet-zoom-animated');
      this._container.id = 'webgl-container';
      this._container.style.pointerEvents = 'none'; // Allow interactions with the map under the overlay

      // Append the container to the map pane
      map.getPanes().overlayPane.appendChild(this._container);

      // Call the function to set up your Three.js content here
      this.drawWebGL(this._container, map.getSize());
    },

    onRemove: function (map) {
      // Clean up and remove the container from the map pane
      map.getPanes().overlayPane.removeChild(this._container);
    },

    // Updated drawWebGL function with Three.js code
    drawWebGL: function (container, size) {
      // Three.js setup
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, size.x / size.y, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ alpha: true });
      renderer.setSize(size.x, size.y);
      container.appendChild(renderer.domElement);

      // Sample cube in the scene
      const geometry = new THREE.BoxGeometry();
      const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
      const cube = new THREE.Mesh(geometry, material);
      scene.add(cube);

      camera.position.z = 5;

      function animate() {
        requestAnimationFrame(animate);

        cube.rotation.x += 0.01;
        cube.rotation.y += 0.01;

        renderer.render(scene, camera);
      }

      animate();

      // Function to update the Three.js scene when the map is panned or zoomed
      function update() {
        const { x, y } = map.containerPointToLatLng([0, 0]);
        const z = map.getZoom();
        const s = map.getSize();
        const alt = 1 + ((s.y * 180) / (512 * 2 ** z)) / 400000;

        // Position the cube based on the map's center and zoom level
        cube.position.set(-y, x, alt);

        renderer.setSize(s.x, s.y);
        camera.aspect = s.x / s.y;
        camera.updateProjectionMatrix();
        renderer.render(scene, camera);
      }

      // Listen for map move events and update the Three.js scene accordingly
      map.on('move', update);
      update();
    }
  });

  // Add the custom layer to the map
  map.addLayer(new customLayer());
</script>
</body>
</html>
